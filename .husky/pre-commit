#!/bin/sh

# Skip hooks in CI
if [ "$CI" = "true" ] || [ "$GITHUB_ACTIONS" = "true" ]; then
  exit 0
fi

echo "ğŸ“¦ Checking for changeset..."
# Check if there are any changesets
CHANGESET_COUNT=$(ls -1 .changeset/*.md 2>/dev/null | grep -v README.md | wc -l | tr -d ' ')

# Check if there are any changed packages
CHANGED_PACKAGES=$(git diff --cached --name-only | grep -E "^packages/" | head -1)

# If packages were changed but no changeset exists, warn the user
if [ -n "$CHANGED_PACKAGES" ] && [ "$CHANGESET_COUNT" -eq "0" ]; then
  echo "âš ï¸  Warning: You've modified packages but haven't created a changeset."
  echo "   Changesets help track package versions and generate changelogs."
  echo ""
  echo "   To create a changeset, run:"
  echo "   pnpm changeset add"
  echo ""
  echo "   To skip this check (for non-release changes like docs/tests), commit with:"
  echo "   git commit --no-verify"
  echo ""
  read -p "   Do you want to continue without a changeset? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Commit cancelled. Please create a changeset first."
    exit 1
  fi
fi

if [ "$CHANGESET_COUNT" -gt "0" ]; then
  echo "âœ… Found $CHANGESET_COUNT changeset(s)"
fi

echo "ğŸ”’ Checking lockfile..."
pnpm install --frozen-lockfile || (echo "âŒ Lockfile is out of date. Run 'pnpm install' to update it." && exit 1)

echo "ğŸ” Running linter..."
pnpm lint || (echo "âŒ Lint failed" && exit 1)

echo "ğŸ”¨ Building project..."
pnpm build || (echo "âŒ Build failed" && exit 1)

echo "ğŸ§ª Running tests..."
pnpm test || (echo "âŒ Tests failed" && exit 1)

echo "ğŸ“ Running lint-staged for changed files..."
npx lint-staged

echo "âœ… Pre-commit checks passed!"